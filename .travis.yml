language: python

python:
  - "3.6"
  - "3.7"
  - "2.7"

virtualenv:
  system_site_packages: false

compiler:
  - gcc

os:
  - linux

sudo: false
dist: xenial

env:
  global:
    - ERT_SHOW_BACKTRACE=1
    - INSTALL_DIR="$(pwd)/install"
    - LD_LIBRARY_PATH="${INSTALL_DIR}/lib:${INSTALL_DIR}/lib64"
    - DYLD_LIBRARY_PATH="${INSTALL_DIR}/lib:${INSTALL_DIR}/lib64"

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - george-edison55-precise-backports
    packages:
      - liblapack-dev
      - valgrind
      - cmake
      - cmake-data
      - gcc

install:
    - git clone --branch master --depth 1 https://github.com/equinor/ert
    - pushd ert
    - pip install --upgrade -r requirements.txt
    - source .libres_version
    - popd
    - git clone --branch $LIBRES_VERSION --depth 1 https://github.com/equinor/libres
    - pushd libres
    - source .libecl_version
    - export LIBRES_TEST_DATA_DIR="$(pwd)/test-data"
    - popd
    - git clone --branch $LIBECL_VERSION --depth 1 https://github.com/equinor/libecl
    - bash ert/.build_install.sh libecl
    - bash ert/.build_install.sh libres
    - export PYTHONPATH=$INSTALL_DIR/lib/python$TRAVIS_PYTHON_VERSION/dist-packages:$PYTHONPATH
    - export PYTHONPATH=$INSTALL_DIR/lib/python$TRAVIS_PYTHON_VERSION/site-packages:$PYTHONPATH
    - PATH=$INSTALL_DIR/bin:$PATH
    - pip install ert/ --prefix=$INSTALL_DIR

script:
  - python setup.py test

deploy:
  - provider: pypi
    user: statoil-travis
    distributions: bdist_wheel sdist
    skip_existing: true
    password:
      secure: hYALJVOFdfNfbWnhA/S+4iyxmlUGThJPtsDZRNGdabzGpls1WRGhbvIoCdDmkvBdYdfJq0596Kg21Hmkh0QVmemgYhZMiiyG6FsuOOt66mKv+TFSLT6BNiYz3WTFvqqE94TkeRU5j7EDmIn7e5C2f1V+TUUr8Da9BVhal9qKj5/V0+oQ7hPhmupdz01yet2WCWZZ1IRahpjISHjJ1wj6Dw0Sf3F9/mP+lWDbda+vpZfMr6/QXqS1m9BtFn7f9UreLK3d+sRtHJ89kxmYhChBJKwZCIyPqfjaf7fhSkL2yLE3taxwQY3BBoe/Jaek9xO4mM0MqhPn7FAFXpm8t/iEBh5COXuR73K9+AP+vGyPqMMU23qfqRvhq0qUD2U2r6JE7dZyrMj5H86ECeUnWTBjblRnQfEvZzKbi8E8kC/XbYqp0rzIi2QeGobJHxW0C3epWhLK8ywhnIZepAYNrgKTGkExHdV+A2UDDUxio4RhtTI3u9UXerR6xpzH4oSm+Y48oeeK1ip47Dx4jha9IlmH8i0Ug4IqKAo78Ek6zViEsBXRSTPO+tFz4lGT750kjAZNytFmX4hOu+cCMFE99dXCLnGz+4IU6tSyIciYIn09iArmPqVZS+jXyDw49Y7pXnZ7te9F+ZArzBxXAem98JPRY0s4P4xmQWLlW5Mf8MWvdGw=
    on:
      tags: true
      branch: master
